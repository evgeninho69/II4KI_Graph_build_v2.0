# Правила генерации графической части межевого плана (HTML/SVG)

Документ описывает структуру проекта, назначение модулей, правила оформления (стили/условные обозначения), логику рендера по листам (SRZU/SGP/CH), а также как тестировать результаты.

## 1. Структура проекта (папки и ключевые модули)

### Зависимости
- **Python**: 3.13+ (или 3.10+)
- **Обязательные библиотеки**:
  - `shapely>=2.0` — для работы с геометрией границ квартала (объединение полигонов, построение внешней границы)
  - `numpy>=1.21` — зависимость shapely
- **Установка**: `python3 -m pip install --break-system-packages shapely`

### Модули

- `src/mp_graphics/app/cli.py` — CLI для запуска пайплайна. Аргументы:
  - `--json` общий контракт CPP; `--xml` демо‑XML; `--txt` демо‑TXT
  - `--srzu-xml` выписка КПТ для SRZU; `--srzu-txt` TXT с контуром целевого ЗУ
  - `--stations-txt` список пунктов ОМС для SGP
  - `--out` директория вывода (использовать одну папку `out`, по умолчанию)
  - `--format` формат листа (A3/A4, по умолчанию A4)
- `src/mp_graphics/app/html_graphics_pipeline.py` — оркестратор: генерирует SRZU/SGP/CH → HTML через шаблон, создает сводку проекта.
- `src/mp_graphics/graphics/svg_generator.py` — генератор SVG: точки/границы/пагинация CH/SGP, place_label для CH/SGP.
- `src/mp_graphics/graphics/label_place.py` — универсальное размещение подписей с выносками и избеганием пересечений.
- `src/mp_graphics/graphics/labels.py` — формирование ярлыков ЗУ, LegendBuilder (tokens → {css,text}).
- `src/mp_graphics/layout/srzu_renderer.py` — рендерер SRZU (рабочая область, буфер смежников, подписи, зона клипа).
- `src/mp_graphics/datasource/import_xml_srzu.py` — **разбор КПТ XML**: извлечение границы квартала из `spatial_data`, смежников, меток; импорт TXT целевого ЗУ.
- `src/mp_graphics/core/page.py` — формат страницы, выбор масштаба по allowed_scales.
- `src/mp_graphics/core/units.py` — mm↔px.
- `src/mp_graphics/exporters/html_publisher.py` — публикация HTML на базе `public/templates/sheet_template.html`.
- `public/templates/` и `public/css/sheets.css` — шаблоны листов и стили (рамки/легенда).

## 2. Правила оформления (условные обозначения)

### I. Характерные точки

| Объект | Оформление | Когда |
| --- | --- | --- |
| Существующая | Чёрный круг d=1.5 мм; обычная подпись | Точка из ЕГРН |
| Новая | Красный круг d=1.5 мм; подпись с префиксом «н» | Создана измерениями |
| Прекращающая | Подпись курсив+подчёркивание | Теряет актуальность |

Общее: подписи с выносками, зазор 1–2 мм от границ.

### II. Границы (линии)

| Объект | Оформление | Когда |
| --- | --- | --- |
| Существующая | Сплошная чёрная 0.2 мм | Между существующими точками |
| Новая | Сплошная красная 0.2 мм | Если хотя бы одна точка новая |
| Недостаточно определённая | Пунктир 2/1 мм, 0.2 мм | При недостаточном определении |

### III. Ярлыки ЗУ (пп. 78–79)

| Операция | Ярлык |
| --- | --- |
| Уточнение | `:123` |
| Раздел/Выдел | `:123:ЗУ1` … |
| Объединение/Перераспределение | `:ЗУ1` … |
| Части (существ.) | `:123/5` |
| Новая часть (на уточняемом) | `:123/чзу1` |
| Новая часть (при разделе) | `:123:ЗУ1/чзу1` |
| Новая часть (при объединении) | `:ЗУ1/чзу1` |

### IV. Доп. элементы по листам

- SGP: пункты ГГС/СПО; направления; точки СГО.
- SRZU: смежные ЗУ; границы кварталов и/или МО; дополнительные зоны (при читаемости).

Легенда — строго по использованным элементам. Tokens → LegendBuilder → `{css,text}` рендерится в `html_publisher`.

## 3. Специфика SRZU

Цель: показать целевой ЗУ в контексте смежников и квартала.

- Источники: КПТ XML (`--srzu-xml`), TXT целевого ЗУ (`--srzu-txt`).
- Буфер смежников: по умолчанию 200 м (`buffer_m`); попадают ЗУ, пересекающие область.
- Масштаб/формат: подбирается A4→A3 по `allowed_scales` [1000, 500, 2000, 5000]. Масштаб в шапке SRZU не печатается.
- Рендер: рабочая область с полями (клип); квартал — синяя 0.3 мм; admin — чёрная 0.2 мм; target — 0.2 мм (красн/чёрн); зоны — зелёные, при `width_m` рисуются двумя параллельными линиями.
- Подписи: номер квартала — синий, ≈18 pt, размещение с выноской; номер ЗУ — по центроиду, одна подпись, при тесноте выноска.

## 4. Специфика SGP

- Отображаются: контур объекта КР, пункты ГГС/СПО, точки СГО, направления.
- Масштаб и формат подбираются автоматически, шрифт ≥ 7 pt.

## 5. Стандарты листа и CSS

### 5.1. Структура листа (CSS Grid Layout)

Все листы (SRZU, SGP, CH) используют единую структуру на базе CSS Grid:

```css
.sheet {
  display: grid;
  grid-template-rows: 
    var(--mt)          /* 11.7mm - верхнее поле */
    var(--header-h)    /* 18mm - заголовок */
    1fr                /* рабочая область (автоматически растягивается) */
    auto               /* строка масштаба (автоматический размер) */
    6mm                /* отступ между масштабом и легендой */
    auto               /* легенда (автоматический размер) */
    var(--mb);         /* 9.6mm - нижнее поле */
  grid-template-columns: var(--ml) 1fr var(--mr);
}
```

## 6. Текущее оформление и алгоритмы (SRZU и CH)

Ниже зафиксированы согласованные стили и алгоритмы генерации графики, реализованные в `src/mp_graphics/graphics/svg_generator.py` и `src/mp_graphics/layout/srzu_renderer.py`.

### 6.1. SRZU (Схема расположения земельных участков)

- Источники данных: `--srzu-txt` (целевой ЗУ), `--srzu-xml` (КПТ: квартал, смежники, админ. границы, зоны).
- Буфер смежников: по центру целевого ЗУ, радиус 300 м (по умолчанию), может быть переопределён `buffer_m`.
- Масштаб: авто-подбор из `allowed_scales` [1000, 500, 2000, 5000]; масштаб в шапке SRZU не печатается.
- Слои и стили (строго совпадают с легендой):
  - `quarters` — границы кадастрового квартала: синий `#1E5AFF`, толщина `0.3mm`; прямоугольный экстент — пунктир `stroke-dasharray="2,1"`.
  - `admin` — административные границы: чёрный `#000000`, толщина `0.2mm`.
  - `adjacent` — смежные ЗУ: серый `#808080`, толщина `0.2mm`, заливка `none`.
  - `target` — целевой ЗУ: сегменты рисуются по статусу точек; новые — красный `#ff0000`, существующие — серый `#808080`. Толщина контура для SRZU — `0.2mm`.
  - `zone` — охранные зоны: зелёный `#00AA00`, толщина `0.2mm`; при наличии `width_m` рисуются парой параллельных линий.
- Подписи:
  - `label-quarter` — номер квартала, синий, ≈18–22 pt, размещение с выноской (алгоритм избегает пересечений с линиями).
  - `label-parcel` — кадастровый номер целевого ЗУ по центроиду, чёрный, ~9–10 pt.
- Точки целевого ЗУ на SRZU: рисуются кружками `r=2mm`, без детальных подписей.
- Легенда: формируется динамически по использованным токенам (`target`, `adjacent`, `quarters`, `admin`, `zone`, `label-quarter`, `label-parcel`).

Реализация: `src/mp_graphics/layout/srzu_renderer.py` — функции `render_srzu`, полилинии квартала/админа, полигоны смежников, сегменты целевого ЗУ рисуются отдельно с добавлением токенов легенды.

### 6.2. CH (Чертеж земельных участков и их частей)

- Содержание: только целевой ЗУ и его характерные точки; без пунктов ОМС/ГГС и направлений (они в SGP).
- Граница ЗУ: рисуется по сегментам с толщиной `0.2mm` и классификацией по статусу конечных точек сегмента:
  - если хотя бы одна из точек сегмента новая (`NEW`/`CREATED`) — красный `#FF0000` (токен `boundary-new`),
  - обе точки существующие — чёрный `#000000` (токен `boundary-existing`),
  - смешанные/неопределённые — чёрный `#000000` с пунктиром `2mm 1mm` (токен `boundary-uncertain`).
- Точки:
  - символ — круг диаметром `POINT_DIAMETER_MM` из `styles.py` (`created/existing` имеют одинаковый размер),
  - цвет: новые — красный `#FF0000`, существующие — чёрный `#000000`, удалённые — чёрный с курсивом/подчёркиванием в подписи,
  - нумерация: новые — префикс `н` + порядковый номер в порядке обхода контура; существующие — порядковый номер без префикса.
- Подписи точек — компактные и без пересечений:
  - первичный сдвиг-кандидат: 1.0 мм по четырём квадрантам [(±1.0, ±1.0) мм],
  - минимальная длина выноски: 0.8 мм,
  - прямоугольник подписи: padding 6 px (внутренний допуск для bbox),
  - буфер точки: `radius_px + 6` px,
  - буфер границы: 8 px по обе стороны от сегмента,
  - начальный вынос от точки для поиска: `radius_px + 8` px,
  - спиральный поиск позиции подписи: шаг 2 px, минимальная дистанция от центра подписи до границы полигона 6 px; проверяются пересечения с bbox других подписей и буферами точек/границ.
- Подпись участка: в центроиде полигона, чёрным, 16 pt; при длинном значении — сокращение до последних 20 символов/части после слеша.
- Пагинация: при необходимости черчение режется на тайлы формата листа с clip-path; подписи дублируются на граничных тайлах и добавляются навигационные подсказки «см. лист N».

Реализация: `src/mp_graphics/graphics/svg_generator.py` — функции `generate_parcel_graphics` (границы и точки с токенами), `generate_drawings_paginated` (тайлинг, размещение подписей c avoidance), вспомогательные `_spiral_search_for_label`, `_get_label_bbox`, `_distance_to_polygon_edge`, `_place_label` и др.

### 6.3. Общие параметры

- Минимальный кегль текста: ≥ 7 pt (перевод в px по 96 DPI),
- Цвета: `red=#FF0000`, `black=#000000`, `blue=#1E5AFF` (SRZU), `green=#00AA00`, `gray=#808080`,
- Толщина линий по умолчанию: `0.2mm`, если явно не указано иное для слоя.


**Преимущества Grid Layout:**
- Рабочая область (`1fr`) автоматически занимает всё доступное пространство
- Легенда (`auto`) подстраивается под содержимое
- При увеличении легенды рабочая область автоматически сжимается
- Элементы никогда не пересекаются

### 5.2. Компоненты листа

**Заголовок (header):**
- Позиция: `grid-row: 2`, `grid-column: 2`
- Высота: 18mm (фиксированная)
- Стиль: `border: 1px solid`, `border-bottom: none`

**Рабочая область (workarea):**
- Позиция: `grid-row: 3`, `grid-column: 2`
- Высота: `1fr` (занимает всё доступное пространство)
- Стиль: `border: 1px solid`, `border-bottom: none` (для стыковки с легендой)
- Минимальная высота: 100px

**Строка масштаба (scale):**
- Позиция: `grid-row: 5`, `grid-column: 2`
- Высота: `auto`
- Стиль: `border-left/right: 1px solid` (без верхней/нижней границы)
- Не отображается для SRZU

**Легенда (legend):**
- Позиция: `grid-row: 6`, `grid-column: 2`
- Высота: `auto` (подстраивается под содержимое)
- Стиль: `border: 1px solid`, `border-top: none` (для стыковки)
- Шрифт: 9pt, вертикальное расположение элементов

### 5.3. Легенда - структура и стили

        **Основные принципы:**
        - **Динамическая генерация на основе `used_tokens`**: Легенда содержит ТОЛЬКО те элементы, которые реально присутствуют на чертеже
        - **Механизм работы**:
          1. При отрисовке каждого элемента (точка, граница, подпись) в `used_legend_tokens` добавляется соответствующий токен
          2. После генерации SVG из `used_legend_tokens` формируется легенда через `LegendBuilder.build(used_tokens)`
          3. В HTML выводятся только элементы, для которых есть токены
        - Вертикальное расположение элементов
        - Автоматическое расширение вверх (без прокрутки)
        - Графические символы 50px × 12px
        
        **Пример для CH:**
        - Если на чертеже 10 новых точек, 10 красных границ и подпись `:ЗУ1`:
          - `used_tokens = {"point-new", "boundary-new", "label-parcel"}`
          - Легенда покажет только эти 3 элемента

**Структура элемента легенды:**
```html
<div class="legend-item">
  <div class="legend-symbol">
    <div class="legend-[token]"></div>
  </div>
  <span>— Описание элемента</span>
</div>
```

**Токены легенды:**

*Для SRZU:*
- `adjacent` — Существующая часть границы (серая линия, 2px, #808080)
- `target` — Вновь образованная часть границы (красная линия, 2.5px, #ff0000)
- `quarters` — Граница кадастрового квартала (синяя линия, 3px, #1E5AFF)
- `admin` — Административные границы (черная линия, 2px, #000000)
- `zone` — Граница охранной зоны (зеленая линия, 2px, #00AA00)
- `label-quarter` — Номер кадастрового квартала (синий текст "69:18:0141401", 7pt)
- `label-parcel` — Номер земельного участка (черный текст ":28", 9pt)

        *Для CH (Чертеж земельных участков и их частей):*
        - `point-existing` — Существующая характерная точка (черный круг d=1.5мм)
        - `point-new` — Образуемая характерная точка (красный круг d=1.5мм)
        - `boundary-existing` — Существующая часть границы (черная сплошная линия 0.2мм)
        - `boundary-new` — Вновь образованная часть границы (красная сплошная линия 0.2мм)
        - `boundary-uncertain` — Часть границы с неопределённостью (черный пунктир 0.2мм)
        - `label-parcel` — Номер земельного участка (черный текст образца ":ЗУ1", 16pt, в центроиде полигона)
        - `label-point-new` — Номер образуемой точки (красный текст "н1", 9pt, снаружи контура)
        - `label-point-existing` — Номер существующей точки (черный текст "1", 9pt, снаружи контура)

*Для SGP:*
- `ggs` — Пункт ГГС/СПО (синий треугольник)
- `geodir-create` — Направление создания съёмочного (синяя линия со стрелкой)
- `geodir-determine` — Направление определения координат (синяя линия)

**CSS стили символов:**
```css
/* Линии */
.legend .legend-[token] { 
  width: 50px; 
  height: 0; 
  border-top: [толщина]px solid [цвет]; 
}

/* Текстовые образцы */
.legend .legend-label-[type]::before { 
  content: "[пример текста]"; 
  color: [цвет];
  font-size: [размер]pt;
}

/* Точки */
.legend .legend-point-[type] { 
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  background: [цвет]; 
}
```

### 5.4. Правила размещения подписей

**Подписи земельных участков:**
- Размещаются в центре полигона (по центроиду) БЕЗ выноски
- Выноска создается ТОЛЬКО при пересечении с другими подписями или линиями
- Шрифт: 10pt для SRZU, 9pt для CH
- Цвет: черный (#000000)
- Формат: сокращенный кадастровый номер (":28", ":2231" и т.д.)

**Подписи кадастрового квартала:**
- Размещаются в центре границы квартала с выноской
- Шрифт: 20pt для SRZU, 18pt для других
- Цвет: синий (#1E5AFF)
- Формат: полный кадастровый номер ("04:11:010120")

**Алгоритм размещения (`prefer_center`):**
```python
# Для подписей участков
prefer_center = (kind == "parcel_label")
lx, ly, leader = place_label(
    (ax, ay), text, avoid, 
    dpi=cfg.dpi, 
    font_size_px=fs_px, 
    prefer_center=prefer_center
)
```

### 5.5. Поля и отступы

- Левое поле (ml): 16.2mm
- Правое поле (mr): 9.8mm
- Верхнее поле (mt): 11.7mm
- Нижнее поле (mb): 9.6mm
- Высота заголовка: 18mm
- Отступ масштаб-легенда: 6mm
- Padding легенды: 4mm × 8mm

## 6. Как запускать и что ожидать

Команда (в единую папку `out`):

```
python -m mp_graphics.app.cli --json data/srzu_mix.json \
  --srzu-xml "Исходные данные/04_11_010120_2024-11-02_kpt11.xml" \
  --srzu-txt "Исходные данные/координаты ЗУ.txt" \
  --out out --format A4
```

Результат: `out/SRZU.html`, `out/SGP.html`, `out/CH_pN.html`, `out/manifest.json`.
Открыть `public/templates/project_summary.html` — сводка подхватит `manifest.json`.

## 7. Тестирование

1) Юнит‑тесты (пример):
- `tests/test_units.py` — проверка mm→px.
- `tests/test_labels.py` — шаблоны ярлыков.

2) Снапшоты SVG/HTML (рекомендуется расширить):
- SRZU: токены легенды (target/adjacent/quarters/admin/zone/label-*); чтение КПТ; наличие клипа и полей.
- SGP: символы пунктов и направлений; размеры линий.
- CH: статусы точек и границ; пагинация без обрезки подписей.

Критерии прохождения:
- На SRZU видны: целевой ЗУ, смежники и квартал; масштаб не печатается; легенда содержит только показанные элементы.

**Границы квартала**: 
- **Источник координат**: Приоритетно извлекаются из секции `cadastral_blocks/cadastral_block/spatial_data/entity_spatial/spatials_elements/spatial_element/ordinates` XML файла выписки КПТ.
- **Формат данных**: Координаты представлены набором точек (ordinate) с параметрами x, y (замкнутый полигон, обычно 50-100 точек).
- **Fallback**: Если секция `spatial_data` отсутствует, граница строится как внешняя граница объединения всех земельных участков квартала (требуется библиотека Shapely). При отсутствии Shapely используется прямоугольный экстент.
- **Отображение**: Синий цвет (#1E5AFF), толщина 0.3 мм, сплошная линия.
- **Подпись**: Кадастровый номер квартала (например, "04:11:010120") размещается с выноской, синий цвет, размер ~18 pt.
- **Требования**: Необходима установка `shapely` для корректной обработки геометрии: `python3 -m pip install --break-system-packages shapely`

- На SGP и CH — шрифт ≥ 7 pt; линии в мм; легенда соответствует использованным токенам.


Условные обозначения делятся на три основные категории: обозначения участков (ярлыки/нотация), обозначения границ (линии) и обозначения характерных точек.

---

### I. Условные Обозначения Характерных Точек

Точки обозначаются как на Чертеже (CH), так и на Схеме геодезических построений (SGP). Их оформление зависит от статуса точки относительно проводимой кадастровой операции.

| Объект | Условное обозначение / Стиль | Когда применяется (Статус точки) | Ссылка в источнике |
| :--- | :--- | :--- | :--- |
| **Существующая точка** | Круг чёрный, диаметр $d=1.5$ мм. Подпись обычная. | Точка, определенная в ЕГРН (существовала ранее). | |
| **Новая точка** | Круг красный, диаметр $d=1.5$ мм. Подпись **с префиксом `н`** (например, `н12`). | Точка, которая создана в результате измерений и не существовала ранее. | |
| **Прекращающая существование точка** | Подпись точки оформляется **курсивом с подчёркиванием**. | Точка, которая перестает быть актуальной в результате кадастровой операции (например, при объединении). | |
| **Общее правило размещения** | Подписи точек должны использовать выноски и не должны перекрывать границы (зазор $1–2$ мм). | Применяется ко всем подписям точек для обеспечения читаемости. | |

### II. Условные Обозначения Границ (Линии)

Границы оформляются в зависимости от их статуса, который определяется статусами их конечных точек. Для их отрисовки используются жесткие пресеты линий (§3.2).

| Объект | Условное обозначение / Стиль | Когда применяется (Статус границы) | Ссылка в источнике |
| :--- | :--- | :--- | :--- |
| **Существующая граница** | **Сплошная чёрная** линия $0.2$ мм. | Граница, определенная в ЕГРН. Может быть только **между двумя существующими точками**. | |
| **Вновь образуемая граница** | **Сплошная красная** линия $0.2$ мм. | Граница, которая образуется в результате кадастровой операции (раздел, выдел, перераспределение). Применяется, **если хотя бы одна из точек, образующих границу, является новой**. | |
| **Неопределимая / Недостаточно определённая граница** | **Пунктир чёрный** $0.2$ мм (штрих $2$ мм, интервал $1$ мм). | Применяется к границам, которые не имеют достаточного определения координат. | |

### III. Условные Обозначения Земельных Участков (Нотация / Ярлыки)

Обозначения (ярлыки/labels) для ЗУ и их частей должны строго соответствовать шаблонам из норм пп. 78–79 Требований. Применение зависит от типа кадастровой операции (`operation`).

| Операция | Объект | Условное обозначение (Ярлык) | Когда применяется | Ссылка в источнике |
| :--- | :--- | :--- | :--- | :--- |
| **Уточнение границ** | Уточняемый ЗУ | `:123` (формат исходного номера квартала). | Для ЗУ, границы которого уточняются. | |
| **Раздел, Выдел** | Образуемый новый ЗУ | `:123:ЗУ1`, `:123:ЗУ2`, ... | Новый ЗУ образуется внутри исходного (номер квартала исходного + «ЗУn»). | |
| **Объединение, Перераспределение** | Образуемый новый ЗУ | `:ЗУ1`, `:ЗУ2`, ... (без номера квартала) | Новый ЗУ образуется из совокупности (объединение) или перераспределения смежных. | |
| **Образование существующих частей ЗУ** | Часть существующего ЗУ | `:123/5` | Для обозначения уже учтенных частей ЗУ. | |
| **Образование новой части ЗУ** | Новая часть ЗУ на уточняемом | `:123/чзу1` | Часть образуется на изменяемом или уточняемом ЗУ. | |
| **Образование новой части ЗУ (при разделе/выделе)** | Новая часть на образуемом ЗУ | `:123:ЗУ1/чзу1` | Часть образуется на новом ЗУ, созданном в результате раздела/выдела. | |
| **Образование новой части ЗУ (при перераспределении/объединении)** | Новая часть на образуемом ЗУ | `:ЗУ1/чзу1` | Часть образуется на новом ЗУ, созданном в результате перераспределения или объединения. | |

### IV. Дополнительные Условные Элементы (По Листам)

| Элемент | Описание | Где применяется | Ссылка в источнике |
| :--- | :--- | :--- | :--- |
| **Пункты ГГС/СПО** | Обозначения пунктов геодезической сети и съемочного обоснования. | На Схеме геодезических построений (**SGP**). | |
| **Направления геодезических построений** | Линии, указывающие направления измерений. | На Схеме геодезических построений (**SGP**). | |
| **Смежные ЗУ, кварталы/муниципальные границы** | Контуры соседних объектов и административно-территориальных границ. | На Схеме расположения земельного участка (**SRZU**). | |
| **Дополнительные зоны** | Иные зоны, не входящие в основные объекты. | На **SRZU**, но только если масштаб позволяет без потери читаемости. | |

**Важное требование к Легенде:** Условные обозначения указываются в легенде **динамически**, только в соответствии с тем, что фактически отображено в графической части чертежа. Программа должна «понимать и видеть, что нарисовано».



Ниже приведены правила и логика оформления границ, точек и подписей, основанные на предоставленной спецификации.

---

## I. Правила оформления Характерных Точек

Оформление точки на чертеже зависит от её статуса, который определяется на этапе **Классификации** (Шаг 2 алгоритма рендера).

| Статус точки | Визуальное оформление | Стиль подписи | Требования к размещению | Ссылки |
| :--- | :--- | :--- | :--- | :--- |
| **Существующая** | **Круг чёрный** (диаметр $d=1.5$ мм). | Обычный шрифт. | Используются **выноски**; подписи не должны перекрывать границы (зазор 1–2 мм). | |
| **Новая** (Образуемая) | **Круг красный** (диаметр $d=1.5$ мм). | Подпись **с префиксом `н`** (например, `н12`). Используется сквозная нумерация по межевому плану. | Используются **выноски**; подписи не должны перекрывать границы (зазор 1–2 мм). | |
| **Прекращающая существование** | (Графический маркер не указан, но применяется к геометрии, которая будет исключена) | Подпись оформляется **курсивом с подчёркиванием**. | Используются **выноски**; подписи не должны перекрывать границы (зазор 1–2 мм). | |

## II. Правила оформления Границ (Линий)

Статус границы (**BoundaryStatus**) напрямую зависит от статусов двух характерных точек, которые её образуют.

### А. Логика определения статуса границы

Ваше предположение о логике полностью соответствует спецификации:

1.  **Существующая граница (Чёрный цвет):**
    *   Граница может быть **существующей (определена в ЕГРН)** **только между двумя существующими точками**.
    *   Она оформляется **сплошной чёрной линией 0.2 мм**.
    *   Если такая граница не меняется в ходе работ, она остаётся чёрной.

2.  **Вновь образуемая граница (Красный цвет):**
    *   Граница считается **вновь образуемой**, если она проходит **между двумя новыми точками**.
    *   Граница считается **вновь образуемой**, если она проходит **от существующей точки к новой точке**.
    *   Она оформляется **сплошной красной линией 0.2 мм**.

3.  **Неопределимая граница:**
    *   Граница оформляется **пунктиром чёрным 0.2 мм** (штрих 2 мм, интервал 1 мм).
    *   Применяется к границам, которые являются **недостаточно определёнными**.

### Б. Оформление границ в зависимости от типа работ

Правила оформления границ и ярлыков **Земельных Участков (ЗУ)** зависят от типа проводимой кадастровой операции (`operation`).

| Тип операции | Оформление границ | Обозначение ЗУ (Ярлык/Label) | Рисуемые объекты | Ссылки |
| :--- | :--- | :--- | :--- | :--- |
| **Уточнение границ** | **Уточняемые отрезки** и точки оформляются по статусу (новые — красные, существующие/неизменные — чёрные). | Формат исходного номера квартала: **`:123`**. | Существующие границы/точки + уточняемые отрезки/точки; показываем различие статусов. | |
| **Раздел / Выдел** | **Новые границы** образуемых ЗУ оформляются **красной линией**. Границы, прекращающие существование (если исходный ЗУ прекращается), оформляются в соответствии со статусом прекращающих существование объектов. | **`:123:ЗУ1`, `:123:ЗУ2`** (номер квартала исходного + «ЗУn»). | Исходный ЗУ (как существующий/прекращающийся); новые ЗУ. | |
| **Объединение** | **Исходные ЗУ** (контуры, которые исчезают) рисуются как **прекращающие существовать**. **Новый внешний контур** оформляется **красной линией**. | **`:ЗУ1`** (без номера квартала). | Исходные — как прекращающие; новый ЗУ. | |
| **Перераспределение** | Рисуются **прекращающиеся/новые части границ** (по статусу). | **`:ЗУ1`, `:ЗУ2`** и т. п. (аналогично объединению). | Прекращающиеся/новые части границ. | |

### III. Оформление Подписей Участков и Частей

Обозначения (ярлыки/labels) ЗУ и их частей должны быть сформированы строго по **шаблонам из норм пп. 78–79 Требований**.

| Тип обозначаемого объекта | Шаблон обозначения | Условие применения | Ссылки |
| :--- | :--- | :--- | :--- |
| **Уточняемый ЗУ** | **`:123`** | Уточнение границ. | |
| **Образуемый ЗУ** (Раздел/Выдел) | **`:123:ЗУ1`** | Образуется внутри единственного исходного ЗУ. | |
| **Образуемый ЗУ** (Объединение/Перераспределение) | **`:ЗУ1`** | Образуется из совокупности или перераспределения смежных ЗУ. | |
| **Существующая часть ЗУ** | **`:123/5`** | Часть уже учтена (например, для обременений). | |
| **Образуемая часть ЗУ** (на уточняемом) | **`:123/чзу1`** | Часть образуется на изменяемом или уточняемом ЗУ. | |
| **Образуемая часть ЗУ** (при разделе/выделе) | **`:123:ЗУ1/чзу1`** | Часть образуется на новом ЗУ, созданном при разделе/выделе. | |
| **Образуемая часть ЗУ** (при перераспределении/объединении) | **`:ЗУ1/чзу1`** | Часть образуется на новом ЗУ, созданном при перераспределении/объединении. | |

Учитывая, что на вход графического модуля могут поступать данные об исходном земельном участке (ЗУ) как в виде каталога координат (например, из TXT-файла), так и в виде **выписки XML на конкретный ЗУ**, необходимо ввести строгие правила классификации геометрических элементов (точек и границ).

Эти правила определяют, имеет ли точка статус **«Существующая»** (определена в ЕГРН) или **«Новая»** (внесена в результате измерений), что, в свою очередь, определяет статус и стиль отрисовки границ.

Данная логика реализуется на этапе **Классификации** (`Step 2` алгоритма рендера), где присваивается `PointStatus` и `BoundaryStatus`.

---
Создание наименований (ярлыков/labels) для земельных участков (ЗУ) и их частей в графическом модуле должно осуществляться **строго по шаблонам, заданным нормами пп. 78–79 Требований**. Модуль использует эти шаблоны в зависимости от типа проводимой кадастровой операции (`operation`), который приходит из «основного интерфейса».



### I. Правила определения статуса земельного участка (ЗУ)

Графический модуль определяет статус исходного ЗУ на основании входных данных, чтобы применить правильное обозначение:

| Исходный ЗУ | Условие определения статуса | Вывод (статус ЗУ) |
| :--- | :--- | :--- |
| **Учтенный / Ранее учтенный ЗУ (один)** | **Одна выписка XML** на земельный участок существует в исходных данных. | Участок является **исходным** и имеет сведения ЕГРН. Для него применяются правила **Уточнения границ** или **Раздела/Выдела**. |
| **Учтенные ЗУ (несколько)** | **Две и более выписок XML** на земельные участки существуют в исходных данных. | Участки являются **исходными объектами** для операций **Объединения/Перераспределения**. |
| **Другой тип / Вновь образуемый** | **Выписки XML на земельные участки отсутствуют**. | Участок не имеет учтенных координат в ЕГРН или является **вновь образуемым** в результате операции. |

### II. Правила создания наименования участка в зависимости от операции

Наименование ЗУ (ярлык/label) генерируется функцией формирования обозначений (`core/labels.ts`) в соответствии с типом операции.

#### 1. Уточнение границ (Участок учтен, его границы уточняются)

Если проводится **Уточнение границ**, обозначение ЗУ сохраняет формат исходного кадастрового номера:

*   **Обозначение ЗУ** остаётся в формате **исходного номера квартала** (аналогично вашему примеру "последние цифры кадастрового номера после двоеточия"): **`:123`**.
*   Полный кадастровый номер (КН) может указываться в подписях.

#### 2. Образование новых участков из одного исходного (Раздел, Выдел)

Если из **одного учтенного ЗУ** (одна XML выписка) образуются новые ЗУ, применяется формат с указанием исходного квартала и порядкового номера нового участка:

*   **Условие**: **Одна XML выписка** на исходный участок (`--parcel-xml`)
*   **Новые ЗУ** маркируются как **`:123:ЗУ1`, `:123:ЗУ2`** и т. д.
*   Обозначение включает **номер квартала исходного ЗУ** + «ЗУn»

#### 3. Образование новых участков из совокупности (Объединение, Перераспределение)

Если образуется новый ЗУ в результате **объединения двух и более ЗУ** или перераспределения смежных ЗУ/земель, обозначение нового ЗУ не привязывается к исходному кварталу:

*   **Условие**: **Две и более XML выписок** на исходные участки (`--parcel-xml-1`, `--parcel-xml-2`, ...)
*   **Новый ЗУ** маркируется как **`:ЗУ1`, `:ЗУ2`** и т. п.
*   Обозначение дается **без номера квартала** (точный номер будет присвоен при учете)

#### 4. Образование частей ЗУ

Если требуется учесть **части** ЗУ (например, для обременений), используются соответствующие суффиксы к основному обозначению:

| Тип части ЗУ | Шаблон обозначения |
| :--- | :--- |
| **Существующая часть** | **`:123/5`** |
| **Образуемая часть** (на уточняемом/изменяемом ЗУ) | **`:123/чзу1`** |
| **Образуемая часть** (при разделе/выделе нового ЗУ) | **`:123:ЗУ1/чзу1`** |
| **Образуемая часть** (при объединении/перераспределении нового ЗУ) | **`:ЗУ1/чзу1`** |

### III. Требования к наименованиям в коде

*   Для реализации этой логики требуется модуль `core/labels.ts`, который содержит **функции генерации обозначений по операции**.
*   Графический модуль должен использовать **валидаторы регексов** для проверки того, что сгенерированные обозначения ЗУ и частей строго соответствуют нормативным шаблонам.
*   **Нотации (`:123`, `:123:ЗУ1`, `:ЗУ1`, `/чзу1` и др.) жёстко заданы** пп. 78–79 «Требований» и используются **как единственный источник истины** в генераторе.