# Правила генерации графической части межевого плана (HTML/SVG)

Документ описывает структуру проекта, назначение модулей, правила оформления (стили/условные обозначения), логику рендера по листам (SRZU/SGP/CH), а также как тестировать результаты.

## 1. Структура проекта (папки и ключевые модули)

### Зависимости
- **Python**: 3.13+ (или 3.10+)
- **Обязательные библиотеки**:
  - `shapely>=2.0` — для работы с геометрией границ квартала (объединение полигонов, построение внешней границы)
  - `numpy>=1.21` — зависимость shapely
- **Установка**: `python3 -m pip install --break-system-packages shapely`

### Модули

- `src/mp_graphics/app/cli.py` — CLI для запуска пайплайна. Аргументы:
  - `--json` общий контракт CPP; `--xml` демо‑XML; `--txt` демо‑TXT
  - `--srzu-xml` выписка КПТ для SRZU; `--srzu-txt` TXT с контуром целевого ЗУ
  - `--stations-txt` список пунктов ОМС для SGP
  - `--out` директория вывода (использовать одну папку `out`, по умолчанию)
  - `--format` формат листа (A3/A4, по умолчанию A4)
- `src/mp_graphics/app/html_graphics_pipeline.py` — оркестратор: генерирует SRZU/SGP/CH → HTML через шаблон, создает сводку проекта.
- `src/mp_graphics/graphics/svg_generator.py` — генератор SVG: точки/границы/пагинация CH/SGP, place_label для CH/SGP.
- `src/mp_graphics/graphics/label_place.py` — универсальное размещение подписей с выносками и избеганием пересечений.
- `src/mp_graphics/graphics/labels.py` — формирование ярлыков ЗУ, LegendBuilder (tokens → {css,text}).
- `src/mp_graphics/layout/srzu_renderer.py` — рендерер SRZU (рабочая область, буфер смежников, подписи, зона клипа).
- `src/mp_graphics/datasource/import_xml_srzu.py` — **разбор КПТ XML**: извлечение границы квартала из `spatial_data`, смежников, меток; импорт TXT целевого ЗУ.
- `src/mp_graphics/core/page.py` — формат страницы, выбор масштаба по allowed_scales.
- `src/mp_graphics/core/units.py` — mm↔px.
- `src/mp_graphics/exporters/html_publisher.py` — публикация HTML на базе `public/templates/sheet_template.html`.
- `public/templates/` и `public/css/sheets.css` — шаблоны листов и стили (рамки/легенда).

## 2. Правила оформления (условные обозначения)

### I. Характерные точки

| Объект | Оформление | Когда |
| --- | --- | --- |
| Существующая | Чёрный круг d=1.5 мм; обычная подпись | Точка из ЕГРН |
| Новая | Красный круг d=1.5 мм; подпись с префиксом «н» | Создана измерениями |
| Прекращающая | Подпись курсив+подчёркивание | Теряет актуальность |

Общее: подписи с выносками, зазор 1–2 мм от границ.

### II. Границы (линии)

| Объект | Оформление | Когда |
| --- | --- | --- |
| Существующая | Сплошная чёрная 0.2 мм | Между существующими точками |
| Новая | Сплошная красная 0.2 мм | Если хотя бы одна точка новая |
| Недостаточно определённая | Пунктир 2/1 мм, 0.2 мм | При недостаточном определении |

### III. Ярлыки ЗУ (пп. 78–79)

| Операция | Ярлык |
| --- | --- |
| Уточнение | `:123` |
| Раздел/Выдел | `:123:ЗУ1` … |
| Объединение/Перераспределение | `:ЗУ1` … |
| Части (существ.) | `:123/5` |
| Новая часть (на уточняемом) | `:123/чзу1` |
| Новая часть (при разделе) | `:123:ЗУ1/чзу1` |
| Новая часть (при объединении) | `:ЗУ1/чзу1` |

### IV. Доп. элементы по листам

- SGP: пункты ГГС/СПО; направления; точки СГО.
- SRZU: смежные ЗУ; границы кварталов и/или МО; дополнительные зоны (при читаемости).

Легенда — строго по использованным элементам. Tokens → LegendBuilder → `{css,text}` рендерится в `html_publisher`.

## 3. Специфика SRZU

Цель: показать целевой ЗУ в контексте смежников и квартала.

- Источники: КПТ XML (`--srzu-xml`), TXT целевого ЗУ (`--srzu-txt`).
- Буфер смежников: по умолчанию 200 м (`buffer_m`); попадают ЗУ, пересекающие область.
- Масштаб/формат: подбирается A4→A3 по `allowed_scales` [1000, 500, 2000, 5000]. Масштаб в шапке SRZU не печатается.
- Рендер: рабочая область с полями (клип); квартал — синяя 0.3 мм; admin — чёрная 0.2 мм; target — 0.2 мм (красн/чёрн); зоны — зелёные, при `width_m` рисуются двумя параллельными линиями.
- Подписи: номер квартала — синий, ≈18 pt, размещение с выноской; номер ЗУ — по центроиду, одна подпись, при тесноте выноска.

## 4. Специфика SGP

- Отображаются: контур объекта КР, пункты ГГС/СПО, точки СГО, направления.
- Масштаб и формат подбираются автоматически, шрифт ≥ 7 pt.

## 5. Стандарты листа и CSS

### 5.1. Структура листа (CSS Grid Layout)

Все листы (SRZU, SGP, CH) используют единую структуру на базе CSS Grid:

```css
.sheet {
  display: grid;
  grid-template-rows: 
    var(--mt)          /* 11.7mm - верхнее поле */
    var(--header-h)    /* 18mm - заголовок */
    1fr                /* рабочая область (автоматически растягивается) */
    auto               /* строка масштаба (автоматический размер) */
    6mm                /* отступ между масштабом и легендой */
    auto               /* легенда (автоматический размер) */
    var(--mb);         /* 9.6mm - нижнее поле */
  grid-template-columns: var(--ml) 1fr var(--mr);
}
```

**Преимущества Grid Layout:**
- Рабочая область (`1fr`) автоматически занимает всё доступное пространство
- Легенда (`auto`) подстраивается под содержимое
- При увеличении легенды рабочая область автоматически сжимается
- Элементы никогда не пересекаются

### 5.2. Компоненты листа

**Заголовок (header):**
- Позиция: `grid-row: 2`, `grid-column: 2`
- Высота: 18mm (фиксированная)
- Стиль: `border: 1px solid`, `border-bottom: none`

**Рабочая область (workarea):**
- Позиция: `grid-row: 3`, `grid-column: 2`
- Высота: `1fr` (занимает всё доступное пространство)
- Стиль: `border: 1px solid`, `border-bottom: none` (для стыковки с легендой)
- Минимальная высота: 100px

**Строка масштаба (scale):**
- Позиция: `grid-row: 5`, `grid-column: 2`
- Высота: `auto`
- Стиль: `border-left/right: 1px solid` (без верхней/нижней границы)
- Не отображается для SRZU

**Легенда (legend):**
- Позиция: `grid-row: 6`, `grid-column: 2`
- Высота: `auto` (подстраивается под содержимое)
- Стиль: `border: 1px solid`, `border-top: none` (для стыковки)
- Шрифт: 9pt, вертикальное расположение элементов

### 5.3. Легенда - структура и стили

**Основные принципы:**
- Динамическая генерация на основе `used_tokens` (только используемые элементы)
- Вертикальное расположение элементов
- Автоматическое расширение вверх (без прокрутки)
- Графические символы 50px × 12px

**Структура элемента легенды:**
```html
<div class="legend-item">
  <div class="legend-symbol">
    <div class="legend-[token]"></div>
  </div>
  <span>— Описание элемента</span>
</div>
```

**Токены легенды:**

*Для SRZU:*
- `adjacent` — Существующая часть границы (серая линия, 2px, #808080)
- `target` — Вновь образованная часть границы (красная линия, 2.5px, #ff0000)
- `quarters` — Граница кадастрового квартала (синяя линия, 3px, #1E5AFF)
- `admin` — Административные границы (черная линия, 2px, #000000)
- `zone` — Граница охранной зоны (зеленая линия, 2px, #00AA00)
- `label-quarter` — Номер кадастрового квартала (синий текст "69:18:0141401", 7pt)
- `label-parcel` — Номер земельного участка (черный текст ":28", 9pt)

*Для CH:*
- `point-existing` — Существующая точка (черный круг, 8px)
- `point-new` — Образуемая точка (красный круг, 8px)
- `point-removed` — Прекращающая точка (серый круг, 8px)
- `boundary-existing` — Существующая часть границы (черная линия, 2px)
- `boundary-new` — Вновь образованная часть границы (красная линия, 2px)
- `boundary-uncertain` — Часть границы с неопределённостью (черный пунктир, 2px)

*Для SGP:*
- `ggs` — Пункт ГГС/СПО (синий треугольник)
- `geodir-create` — Направление создания съёмочного (синяя линия со стрелкой)
- `geodir-determine` — Направление определения координат (синяя линия)

**CSS стили символов:**
```css
/* Линии */
.legend .legend-[token] { 
  width: 50px; 
  height: 0; 
  border-top: [толщина]px solid [цвет]; 
}

/* Текстовые образцы */
.legend .legend-label-[type]::before { 
  content: "[пример текста]"; 
  color: [цвет];
  font-size: [размер]pt;
}

/* Точки */
.legend .legend-point-[type] { 
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  background: [цвет]; 
}
```

### 5.4. Правила размещения подписей

**Подписи земельных участков:**
- Размещаются в центре полигона (по центроиду) БЕЗ выноски
- Выноска создается ТОЛЬКО при пересечении с другими подписями или линиями
- Шрифт: 10pt для SRZU, 9pt для CH
- Цвет: черный (#000000)
- Формат: сокращенный кадастровый номер (":28", ":2231" и т.д.)

**Подписи кадастрового квартала:**
- Размещаются в центре границы квартала с выноской
- Шрифт: 20pt для SRZU, 18pt для других
- Цвет: синий (#1E5AFF)
- Формат: полный кадастровый номер ("04:11:010120")

**Алгоритм размещения (`prefer_center`):**
```python
# Для подписей участков
prefer_center = (kind == "parcel_label")
lx, ly, leader = place_label(
    (ax, ay), text, avoid, 
    dpi=cfg.dpi, 
    font_size_px=fs_px, 
    prefer_center=prefer_center
)
```

### 5.5. Поля и отступы

- Левое поле (ml): 16.2mm
- Правое поле (mr): 9.8mm
- Верхнее поле (mt): 11.7mm
- Нижнее поле (mb): 9.6mm
- Высота заголовка: 18mm
- Отступ масштаб-легенда: 6mm
- Padding легенды: 4mm × 8mm

## 6. Как запускать и что ожидать

Команда (в единую папку `out`):

```
python -m mp_graphics.app.cli --json data/srzu_mix.json \
  --srzu-xml "Исходные данные/04_11_010120_2024-11-02_kpt11.xml" \
  --srzu-txt "Исходные данные/координаты ЗУ.txt" \
  --out out --format A4
```

Результат: `out/SRZU.html`, `out/SGP.html`, `out/CH_pN.html`, `out/manifest.json`.
Открыть `public/templates/project_summary.html` — сводка подхватит `manifest.json`.

## 7. Тестирование

1) Юнит‑тесты (пример):
- `tests/test_units.py` — проверка mm→px.
- `tests/test_labels.py` — шаблоны ярлыков.

2) Снапшоты SVG/HTML (рекомендуется расширить):
- SRZU: токены легенды (target/adjacent/quarters/admin/zone/label-*); чтение КПТ; наличие клипа и полей.
- SGP: символы пунктов и направлений; размеры линий.
- CH: статусы точек и границ; пагинация без обрезки подписей.

Критерии прохождения:
- На SRZU видны: целевой ЗУ, смежники и квартал; масштаб не печатается; легенда содержит только показанные элементы.

**Границы квартала**: 
- **Источник координат**: Приоритетно извлекаются из секции `cadastral_blocks/cadastral_block/spatial_data/entity_spatial/spatials_elements/spatial_element/ordinates` XML файла выписки КПТ.
- **Формат данных**: Координаты представлены набором точек (ordinate) с параметрами x, y (замкнутый полигон, обычно 50-100 точек).
- **Fallback**: Если секция `spatial_data` отсутствует, граница строится как внешняя граница объединения всех земельных участков квартала (требуется библиотека Shapely). При отсутствии Shapely используется прямоугольный экстент.
- **Отображение**: Синий цвет (#1E5AFF), толщина 0.3 мм, сплошная линия.
- **Подпись**: Кадастровый номер квартала (например, "04:11:010120") размещается с выноской, синий цвет, размер ~18 pt.
- **Требования**: Необходима установка `shapely` для корректной обработки геометрии: `python3 -m pip install --break-system-packages shapely`

- На SGP и CH — шрифт ≥ 7 pt; линии в мм; легенда соответствует использованным токенам.


